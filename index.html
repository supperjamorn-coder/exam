<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แบบทดสอบการขับรถฟอร์คลิฟต์</title>
    <!-- Use Tailwind CSS for a clean, modern design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 800px;
        }
        /* Custom styles for the app */
        .card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1.5rem;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: #ffffff;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #4b5563;
        }
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        .choice-btn {
            width: 100%;
            text-align: left;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            padding: 1rem;
            transition: all 0.2s ease-in-out;
            border: 1px solid #d1d5db;
        }
        .choice-btn:hover:not(.selected) {
            background-color: #f3f4f6;
        }
        .choice-btn.selected {
            background-color: #bfdbfe;
            border-color: #60a5fa;
            color: #1e40af;
            font-weight: 700;
        }
        .message-box {
            position: fixed;
            top: 2rem;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 2rem;
            border-radius: 8px;
            color: #fff;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .message-box.show {
            display: block;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <!-- Main App Container -->
    <div id="app" class="container mx-auto">
        <!-- Loading Spinner and Message -->
        <div id="loading" class="text-center text-gray-500 hidden">
            <svg class="animate-spin h-10 w-10 text-blue-500 mx-auto mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p>กำลังโหลดข้อมูล... กรุณารอสักครู่</p>
        </div>

        <!-- Start Page -->
        <div id="start-page" class="card text-center transition-opacity duration-500">
            <h1 class="text-3xl font-bold text-gray-800 mb-4">แบบทดสอบความรู้การขับรถฟอร์คลิฟต์</h1>
            <p class="text-gray-600 mb-6">เตรียมความพร้อมก่อนสอบใบขับขี่รถฟอร์คลิฟต์</p>
            <button id="start-btn" class="btn btn-primary w-full">เริ่มทำแบบทดสอบ</button>
        </div>

        <!-- Exam Page -->
        <div id="exam-page" class="hidden transition-opacity duration-500">
            <div class="card">
                <div class="flex justify-between items-center mb-4">
                    <p id="question-counter" class="text-sm text-gray-500">คำถามที่ 1/30</p>
                </div>
                
                <div id="question-content" class="mb-6">
                    <!-- Question text and image will be rendered here -->
                </div>
                
                <div id="choices-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Answer choices will be rendered here -->
                </div>
                
                <!-- Navigation Buttons -->
                <div class="flex justify-between mt-6">
                    <button id="prev-btn" class="btn btn-secondary" style="visibility: hidden;">ย้อนกลับ</button>
                    <button id="next-btn" class="btn btn-primary">คำถามถัดไป</button>
                    <button id="submit-btn" class="btn btn-primary hidden">ส่งคำตอบ</button>
                </div>
            </div>
        </div>

        <!-- Result Page -->
        <div id="result-page" class="hidden transition-opacity duration-500">
            <div class="card text-center">
                <h2 class="text-3xl font-bold text-gray-800 mb-4">ผลการสอบ</h2>
                <div class="mb-6">
                    <p class="text-2xl font-bold text-blue-600 mb-2">คะแนนของคุณ</p>
                    <p id="final-score" class="text-6xl font-extrabold text-blue-600">0</p>
                    <p class="text-sm text-gray-500">จาก 30 คะแนน</p>
                </div>
                <div class="mb-6">
                    <p class="text-2xl font-bold text-gray-800">ผลลัพธ์: <span id="pass-fail-text"></span></p>
                </div>
                <!-- Show correct answers -->
                <div id="answers-review-container" class="text-left mt-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">เฉลย</h3>
                </div>
                <button id="restart-btn" class="btn btn-primary w-full mt-8">ลองใหม่อีกครั้ง</button>
            </div>
        </div>
    </div>
    
    <!-- Message Box for alerts -->
    <div id="message-box" class="message-box"></div>

    <script>
        // Define the URL for the Google Apps Script Web App
        const url = 'https://script.google.com/macros/s/AKfycbyu01R4R-4c2jyxPZqqX8aQnkEpc5o3haZIn5CuzRt4TGdY8UO8x0QDlUBjWw8u2DoB3Q/exec';

        // Get DOM elements
        const loadingScreen = document.getElementById('loading');
        const startPage = document.getElementById('start-page');
        const examPage = document.getElementById('exam-page');
        const resultPage = document.getElementById('result-page');
        const startBtn = document.getElementById('start-btn');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const submitBtn = document.getElementById('submit-btn');
        const restartBtn = document.getElementById('restart-btn');
        const questionCounter = document.getElementById('question-counter');
        const questionContent = document.getElementById('question-content');
        const choicesContainer = document.getElementById('choices-container');
        const finalScore = document.getElementById('final-score');
        const passFailText = document.getElementById('pass-fail-text');
        const messageBox = document.getElementById('message-box');
        const answersReviewContainer = document.getElementById('answers-review-container');

        // App state variables
        let examData = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];

        /**
         * Fetches exam data from the Google Apps Script Web App.
         * @returns {Promise<void>}
         */
        async function fetchExamData() {
            startPage.classList.add('hidden');
            loadingScreen.classList.remove('hidden');
            userAnswers = []; // Reset user answers
            
            try {
                const response = await fetch(url + '?action=getExamDataAsJson');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                if (data && data.questions) {
                    examData = data.questions;
                    // Preload all images before showing the exam page
                    preloadImages();
                } else {
                    console.error('Invalid data format:', data);
                    showMessage('ข้อผิดพลาด: ไม่สามารถโหลดข้อมูลได้', 'error');
                }
            } catch (error) {
                console.error('Error fetching exam data:', error);
                showMessage('ข้อผิดพลาดในการเชื่อมต่อ: กรุณาลองใหม่อีกครั้ง', 'error');
            }
        }
        
        /**
         * Preloads all images from the exam data.
         * @returns {Promise<void>}
         */
        async function preloadImages() {
            const imagePromises = [];
            const allImageUrls = new Set();
        
            // Collect all unique image URLs from questions and choices
            examData.forEach(question => {
                if (question.QuestionImageURL) {
                    let imgSrc = question.QuestionImageURL;
                    let driveMatch = imgSrc.match(/\/file\/d\/([\w-]+)\/view/);
                    if (!driveMatch) {
                        driveMatch = imgSrc.match(/\/open\?id=([\w-]+)/);
                    }
                    if (driveMatch) {
                        const fileId = driveMatch[1];
                        imgSrc = `https://lh3.googleusercontent.com/d/${fileId}=s1000`;
                    }
                    allImageUrls.add(imgSrc);
                }
                question.choices.forEach(choice => {
                    if (choice.AnswerImageURL) {
                        allImageUrls.add(choice.AnswerImageURL);
                    }
                });
            });

            // Create a promise for each image to be loaded
            allImageUrls.forEach(imageUrl => {
                const promise = new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => resolve();
                    img.onerror = () => {
                        console.warn(`Failed to preload image: ${imageUrl}`);
                        resolve(); // Resolve anyway to allow the app to continue
                    };
                    img.src = imageUrl;
                });
                imagePromises.push(promise);
            });
            
            // Wait for all images to load (or fail to load)
            await Promise.allSettled(imagePromises);
            
            // Once all images are preloaded, show the exam page
            loadingScreen.classList.add('hidden');
            showPage('exam-page');
            renderQuestion();
        }

        /**
         * Renders the current question and its choices.
         */
        function renderQuestion() {
            // Clear previous content
            questionContent.innerHTML = '';
            choicesContainer.innerHTML = '';
            
            const question = examData[currentQuestionIndex];
            
            // Render question text
            const questionTextElement = document.createElement('h3');
            questionTextElement.className = 'text-lg font-medium text-gray-700 mb-4';
            questionTextElement.textContent = `คำถามที่ ${currentQuestionIndex + 1}: ${question.QuestionText}`;
            questionContent.appendChild(questionTextElement);
            

            // Render question image if available
            if (question.QuestionImageURL) {
                let imgSrc = question.QuestionImageURL;
                // Attempt to get the file ID from various Google Drive URL formats
                let driveMatch = imgSrc.match(/\/file\/d\/([\w-]+)\/view/);
                if (!driveMatch) {
                    driveMatch = imgSrc.match(/\/open\?id=([\w-]+)/);
                }
                if (driveMatch) {
                    const fileId = driveMatch[1];
                    imgSrc = `https://lh3.googleusercontent.com/d/${fileId}=s1000`; // Use a different Google server for direct embedding
                }
                
                const imgElement = document.createElement('img');
                imgElement.src = imgSrc;
                imgElement.alt = 'Question Image';
                imgElement.className = 'mb-4 w-full h-auto rounded-lg shadow-sm';
                
                // Add an onerror handler to show a message if the image fails to load
                imgElement.onerror = () => {
                    console.error('Failed to load image from URL:', imgSrc);
                    const errorMsg = document.createElement('p');
                    errorMsg.className = 'text-red-500 text-center text-sm';
                    errorMsg.textContent = 'ไม่สามารถแสดงรูปภาพได้ กรุณาตรวจสอบ URL รูปภาพ';
                    questionContent.appendChild(errorMsg);
                    // Remove the broken image element
                    imgElement.remove();
                };

                questionContent.appendChild(imgElement);
            }
            
            // Update question counter
            questionCounter.textContent = `คำถามที่ ${currentQuestionIndex + 1}/${examData.length}`;
            
            // Render answer choices
            question.choices.forEach((choice, index) => {
                const choiceBtn = document.createElement('button');
                choiceBtn.className = 'choice-btn relative flex items-center';
                
                const choiceLabel = String.fromCharCode(65 + index) + '. '; // A, B, C, D
                const choiceContent = document.createElement('div');
                choiceContent.className = 'flex flex-col items-start';
                
                // Add choice text
                const textSpan = document.createElement('span');
                textSpan.textContent = choiceLabel + choice.AnswerText;
                textSpan.className = 'font-semibold text-gray-700';
                choiceContent.appendChild(textSpan);

                // Add choice image if available
                if (choice.AnswerImageURL) {
                    const imgElement = document.createElement('img');
                    imgElement.src = choice.AnswerImageURL;
                    imgElement.alt = 'Answer Image';
                    imgElement.className = 'mt-2 rounded-md shadow-sm w-48 h-auto';
                    choiceContent.appendChild(imgElement);
                }

                choiceBtn.appendChild(choiceContent);
                choicesContainer.appendChild(choiceBtn);

                // Check if this choice was previously selected by the user
                if (userAnswers[currentQuestionIndex] && userAnswers[currentQuestionIndex].AnswerText === choice.AnswerText) {
                    choiceBtn.classList.add('selected');
                }

                // Add event listener for choice selection
                choiceBtn.addEventListener('click', () => handleChoice(choiceBtn, choice));
            });
            
            // Manage navigation buttons visibility
            prevBtn.style.visibility = (currentQuestionIndex > 0) ? 'visible' : 'hidden';
            if (currentQuestionIndex === examData.length - 1) {
                nextBtn.classList.add('hidden');
                submitBtn.classList.remove('hidden');
            } else {
                nextBtn.classList.remove('hidden');
                submitBtn.classList.add('hidden');
            }
        }

        /**
         * Handles the user's choice and updates the userAnswers array.
         * @param {HTMLElement} selectedBtn The button element that was clicked.
         * @param {object} selectedChoice The chosen answer object.
         */
        function handleChoice(selectedBtn, selectedChoice) {
            // Deselect any previously selected choice for this question
            const choiceButtons = choicesContainer.querySelectorAll('.choice-btn');
            choiceButtons.forEach(btn => btn.classList.remove('selected'));
            
            // Select the new choice
            selectedBtn.classList.add('selected');

            // Record the user's choice
            userAnswers[currentQuestionIndex] = selectedChoice;
        }

        /**
         * Moves to the next question.
         */
        function nextQuestion() {
            currentQuestionIndex++;
            renderQuestion();
        }
        
        /**
         * Moves to the previous question.
         */
        function prevQuestion() {
            currentQuestionIndex--;
            renderQuestion();
        }

        /**
         * Displays the final result page and calculates the score.
         */
        function submitExam() {
            let finalScoreCount = 0;
            examData.forEach((question, index) => {
                const userAnswer = userAnswers[index];
                const correctAnswer = question.choices.find(c => c.IsCorrect);
                if (userAnswer && userAnswer.AnswerText === correctAnswer.AnswerText) {
                    finalScoreCount++;
                }
            });

            showPage('result-page');
            finalScore.textContent = finalScoreCount;
            const passThreshold = 24; // 80% of 30 questions
            if (finalScoreCount >= passThreshold) {
                passFailText.textContent = 'ผ่าน';
                passFailText.classList.add('text-green-600');
                passFailText.classList.remove('text-red-600');
            } else {
                passFailText.textContent = 'ไม่ผ่าน';
                passFailText.classList.add('text-red-600');
                passFailText.classList.remove('text-green-600');
            }
            renderAnswersReview();
        }
        
        /**
         * Renders the answers review section on the result page.
         */
        function renderAnswersReview() {
            answersReviewContainer.innerHTML = '<h3 class="text-xl font-bold text-gray-800 mb-4">เฉลย</h3>';
            
            examData.forEach((question, index) => {
                const questionReview = document.createElement('div');
                questionReview.className = 'mb-6 p-4 rounded-lg';
                
                const userAnswer = userAnswers[index];
                const correctAnswer = question.choices.find(c => c.IsCorrect);
                
                const isCorrect = (userAnswer && userAnswer.AnswerText === correctAnswer.AnswerText);

                if (isCorrect) {
                    questionReview.classList.add('bg-green-50');
                } else {
                    questionReview.classList.add('bg-red-50');
                }
                
                let reviewContent = `
                    <p class="font-bold mb-2">คำถามที่ ${index + 1}: ${question.QuestionText}</p>
                    <p class="text-green-700 font-semibold">✅ คำตอบที่ถูกต้อง: ${correctAnswer.AnswerText}</p>
                `;

                if (!isCorrect) {
                    if (userAnswer) {
                        reviewContent += `<p class="text-red-700 font-semibold">❌ คำตอบของคุณ: ${userAnswer.AnswerText}</p>`;
                    } else {
                        reviewContent += `<p class="text-red-700 font-semibold">❌ คุณไม่ได้ตอบคำถามนี้</p>`;
                    }
                }
                
                questionReview.innerHTML = reviewContent;
                answersReviewContainer.appendChild(questionReview);
            });
        }

        /**
         * Resets the quiz and goes back to the start page.
         */
        function restartQuiz() {
            currentQuestionIndex = 0;
            userAnswers = [];
            showPage('start-page');
        }

        /**
         * Handles page visibility.
         * @param {string} pageId The ID of the page to show.
         */
        function showPage(pageId) {
            const pages = [startPage, examPage, resultPage, loadingScreen];
            pages.forEach(page => {
                if (page.id === pageId) {
                    page.classList.remove('hidden');
                    page.classList.add('animate-fade-in');
                } else {
                    page.classList.add('hidden');
                    page.classList.remove('animate-fade-in');
                }
            });
        }
        
        /**
         * Shows a temporary message box.
         * @param {string} message The message to display.
         * @param {string} type The type of message ('success' or 'error').
         */
        function showMessage(message, type) {
            messageBox.textContent = message;
            messageBox.style.backgroundColor = type === 'success' ? '#10b981' : '#ef4444';
            messageBox.classList.add('show');
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 2000);
        }

        // Event Listeners
        startBtn.addEventListener('click', fetchExamData);
        nextBtn.addEventListener('click', nextQuestion);
        prevBtn.addEventListener('click', prevQuestion);
        submitBtn.addEventListener('click', submitExam);
        restartBtn.addEventListener('click', restartQuiz);
    </script>

    <!--
    สรุปการแก้ไขโค้ด:

    1.  ส่วนการโหลดรูปภาพล่วงหน้า (Preloading Images):
        -   **ฟังก์ชัน `preloadImages()`:** ถูกเพิ่มเข้ามาเพื่อทำการโหลดรูปภาพทั้งหมดที่ใช้ในแบบทดสอบ (ทั้งรูปในคำถามและรูปในตัวเลือก) ก่อนที่จะเริ่มแสดงหน้าแบบทดสอบจริง
        -   **การตรวจสอบ URL:** ภายในฟังก์ชัน `preloadImages()` มีการตรวจสอบ URL ของรูปภาพจาก Google Drive และแปลงให้อยู่ในรูปแบบที่สามารถแสดงผลได้บนหน้าเว็บ
        -   **`Promise.allSettled()`:** ใช้คำสั่งนี้เพื่อรอให้รูปภาพทั้งหมดโหลดเสร็จสิ้น (ไม่ว่าจะสำเร็จหรือล้มเหลว) ก่อนที่จะดำเนินการต่อ เพื่อให้มั่นใจว่าผู้ใช้จะไม่เห็นรูปภาพที่กำลังโหลดอยู่ระหว่างทำแบบทดสอบ
        -   **การเชื่อมต่อ:** หลังจาก `fetchExamData()` ดึงข้อมูลชุดคำถามมาได้แล้ว จะเรียก `preloadImages()` เพื่อเริ่มกระบวนการโหลดรูปภาพล่วงหน้าแทนการแสดงคำถามทันที
// โค้ดเดิมที่พบปัญหาไม่สามารถ แสดงรูปภาพได้
if (question.QuestionImageURL) {
    const imgElement = document.createElement('img');
    imgElement.src = question.QuestionImageURL; // URL นี้ไม่สามารถแสดงผลได้โดยตรง
    imgElement.alt = 'Question Image';
    imgElement.className = 'mb-4 w-full h-auto rounded-lg shadow-sm';
    questionContent.appendChild(imgElement);
}

โค้ดที่ แก้ไขแล้ว และแสดงรูปภาพได้
// โค้ดที่แก้ไขแล้ว
if (question.QuestionImageURL) {
    let imgSrc = question.QuestionImageURL;
    // Attempt to get the file ID from various Google Drive URL formats
    let driveMatch = imgSrc.match(/\/file\/d\/([\w-]+)\/view/);
    if (!driveMatch) {
        driveMatch = imgSrc.match(/\/open\?id=([\w-]+)/);
    }
    if (driveMatch) {
        const fileId = driveMatch[1];
        imgSrc = `https://lh3.googleusercontent.com/d/${fileId}=s1000`; // แปลงเป็น URL รูปแบบที่ถูกต้อง
    }
    
    const imgElement = document.createElement('img');
    imgElement.src = imgSrc;
    imgElement.alt = 'Question Image';
    imgElement.className = 'mb-4 w-full h-auto rounded-lg shadow-sm';
    
    // Add an onerror handler to show a message if the image fails to load
    imgElement.onerror = () => {
        console.error('Failed to load image from URL:', imgSrc);
        const errorMsg = document.createElement('p');
        errorMsg.className = 'text-red-500 text-center text-sm';
        errorMsg.textContent = 'ไม่สามารถแสดงรูปภาพได้ กรุณาตรวจสอบ URL รูปภาพ';
        questionContent.appendChild(errorMsg);
        // Remove the broken image element
        imgElement.remove();
    };

    questionContent.appendChild(imgElement);
}

    2.  ส่วนการแสดงผลเฉลยข้อสอบ:
        -   **ฟังก์ชัน `renderAnswersReview()`:** ได้รับการแก้ไขให้ลบส่วนที่แสดงรูปภาพของเฉลยออกไป
        -   **การแสดงผล:** ตอนนี้ในหน้าเฉลยจะแสดงเฉพาะข้อความของคำถามและคำตอบที่ถูกต้อง รวมถึงคำตอบของผู้ใช้ (ถ้ามี) โดยไม่มีรูปภาพประกอบแล้วตามที่คุณต้องการ
    -->
</body>
</html>
